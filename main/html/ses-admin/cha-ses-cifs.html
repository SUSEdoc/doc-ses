<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes"/><title>Export Ceph data via Samba | Administration and Operations Guide | SUSE Enterprise Storage 7.1</title><link rel="stylesheet" type="text/css" href="static/css/style.css"/>
<meta name="title" content="Export Ceph data via Samba | SES 7.1"/>
<meta name="description" content="This chapter describes how to export data stored in a Ceph cluster via a Samba/CIFS share so that you can easily access them from Windows* client mac…"/>
<meta name="product-name" content="SUSE Enterprise Storage"/>
<meta name="product-number" content="7.1"/>
<meta name="book-title" content="Administration and Operations Guide"/>
<meta name="chapter-title" content="Chapter 24. Export Ceph data via Samba"/>
<meta name="tracker-url" content="https://github.com/SUSE/doc-ses/issues/new"/>
<meta name="tracker-type" content="gh"/>
<meta name="tracker-gh-assignee" content="tbazant"/>
<meta name="tracker-gh-template" content="&#10;     ### Type of report&#10;   - [ ] bug&#10;   - [ ] feature request&#10;&#10;### Source Document&#10;@@source@@&#10;&#10;### Summary&#10;&lt;!-- A clear and concise description of what the bug/feature request is. --&gt;&#10;&#10;### Steps To Reproduce&#10;&lt;!-- Steps to reproduce the behavior if you ran through steps in the document. --&gt;&#10;&#10;### Expected Results&#10;&lt;!-- A clear and concise description of what you expected to happen. --&gt;&#10;&#10;### Actual Results&#10;&lt;!-- Explain what actually happened if steps were executed, and if applicable, add screenshots to help explain your problem. --&gt;&#10;&#10;### Notes&#10;&lt;!-- Add any other context about the problem here. --&gt;&#10;&#10;    "/>
<meta name="tracker-gh-labels" content="bug,question,feature request"/>
<meta property="og:title" content="Export Ceph data via Samba | SES 7.1"/>
<meta property="og:description" content="This chapter describes how to export data stored in a Ceph cluster via a Samba/CIFS share so that you can easily access them from Windows* client mac…"/>
<meta property="og:type" content="article"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Export Ceph data via Samba | SES 7.1"/>
<meta name="twitter:description" content="This chapter describes how to export data stored in a Ceph cluster via a Samba/CIFS share so that you can easily access them from Windows* client mac…"/>
<link rel="prev" href="cha-ceph-cephfs.html" title="Chapter 23. Clustered file system"/><link rel="next" href="cha-ceph-nfsganesha.html" title="Chapter 25. NFS Ganesha"/>
<script type="text/javascript">

if ( window.location.protocol.toLowerCase() != 'file:' ) {
  document.write('<link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"></link>');
};

</script><noscript><link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"/></noscript><script src="static/js/jquery-1.12.4.min.js" type="text/javascript"> </script><script src="static/js/script.js" type="text/javascript"> </script><script src="static/js/highlight.min.js" type="text/javascript"> </script><script>

$(document).ready(function() {
  $('.verbatim-wrap.highlight').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});
hljs.configure({
  useBR: false
});

</script></head><body class="draft wide offline js-off" onload="$('#betawarn-button-wrap').toggle();if (document.cookie.length > 0) {if (document.cookie.indexOf('betawarn=closed') != -1){$('#betawarn').toggle()}};"><div id="betawarn" style="position:fixed;bottom:0;z-index:9025;background-color:#FDE8E8;padding:1em;margin-left:10%;margin-right:10%;display:block;border-top:.75em solid #E11;width:80%"><p style="color:#333;margin:1em 0;padding:0;">This is a draft document that was built and uploaded automatically. It may document beta software and be incomplete or even incorrect. <strong>Use this document at your own risk.</strong></p> <div id="betawarn-button-wrap" style="display:none;margin:0;padding:0;"><a href="#" onclick="$('#betawarn').toggle();var d=new Date();d.setTime(d.getTime()+(0.5*24*60*60*1000));document.cookie='betawarn=closed; expires='+d.toUTCString()+'; path=/'; return false;" style="color:#333;text-decoration:underline;float:left;margin-top:.5em;padding:1em;display:block;background-color:#FABEBE;">I understand this is a draft</a></div></div><div class="bypass-block"><a href="#_content">Jump to content</a><a href="#_bottom-pagination">Jump to page navigation: previous page [access key p]/next page [access key n]</a></div><header id="_mainnav"><div class="growth-inhibitor"><img src="static/images/logo.svg" alt="Logo" class="logo"/></div></header><div class="crumbs"><div class="growth-inhibitor"><a class="crumb" href="index.html">Administration and Operations Guide</a><span> / </span><a class="crumb" href="part-accessing-data.html">Accessing Cluster Data</a><span> / </span><a class="crumb" href="cha-ses-cifs.html">Export Ceph data via Samba</a></div></div><main id="_content"><nav id="_side-toc-overall" class="side-toc"><div class="side-title">Administration and Operations Guide</div><ol><li><a href="preface-admin.html" class=" "><span class="title-number"> </span><span class="title-name">About this guide</span></a></li><li><a href="part-dashboard.html" class="has-children "><span class="title-number">I </span><span class="title-name">Ceph Dashboard</span></a><ol><li><a href="dashboard-about.html" class=" "><span class="title-number">1 </span><span class="title-name">About the Ceph Dashboard</span></a></li><li><a href="dashboard-webui-general.html" class=" "><span class="title-number">2 </span><span class="title-name">Dashboard's Web user interface</span></a></li><li><a href="dashboard-user-mgmt.html" class=" "><span class="title-number">3 </span><span class="title-name">Manage Ceph Dashboard users and roles</span></a></li><li><a href="dashboard-cluster.html" class=" "><span class="title-number">4 </span><span class="title-name">View cluster internals</span></a></li><li><a href="dashboard-pools.html" class=" "><span class="title-number">5 </span><span class="title-name">Manage pools</span></a></li><li><a href="dashboard-rbds.html" class=" "><span class="title-number">6 </span><span class="title-name">Manage RADOS Block Device</span></a></li><li><a href="dash-webui-nfs.html" class=" "><span class="title-number">7 </span><span class="title-name">Manage NFS Ganesha</span></a></li><li><a href="dashboard-mds.html" class=" "><span class="title-number">8 </span><span class="title-name">Manage CephFS</span></a></li><li><a href="dashboard-ogw.html" class=" "><span class="title-number">9 </span><span class="title-name">Manage the Object Gateway</span></a></li><li><a href="dashboard-initial-configuration.html" class=" "><span class="title-number">10 </span><span class="title-name">Manual configuration</span></a></li><li><a href="dashboard-user-roles.html" class=" "><span class="title-number">11 </span><span class="title-name">Manage users and roles on the command line</span></a></li></ol></li><li><a href="part-cluster-operation.html" class="has-children "><span class="title-number">II </span><span class="title-name">Cluster Operation</span></a><ol><li><a href="ceph-monitor.html" class=" "><span class="title-number">12 </span><span class="title-name">Determine the cluster state</span></a></li><li><a href="storage-salt-cluster.html" class=" "><span class="title-number">13 </span><span class="title-name">Operational tasks</span></a></li><li><a href="cha-ceph-operating.html" class=" "><span class="title-number">14 </span><span class="title-name">Operation of Ceph services</span></a></li><li><a href="cha-deployment-backup.html" class=" "><span class="title-number">15 </span><span class="title-name">Backup and restore</span></a></li><li><a href="monitoring-alerting.html" class=" "><span class="title-number">16 </span><span class="title-name">Monitoring and alerting</span></a></li></ol></li><li><a href="part-storing-data.html" class="has-children "><span class="title-number">III </span><span class="title-name">Storing Data in a Cluster</span></a><ol><li><a href="cha-storage-datamgm.html" class=" "><span class="title-number">17 </span><span class="title-name">Stored data management</span></a></li><li><a href="ceph-pools.html" class=" "><span class="title-number">18 </span><span class="title-name">Manage storage pools</span></a></li><li><a href="cha-ceph-erasure.html" class=" "><span class="title-number">19 </span><span class="title-name">Erasure coded pools</span></a></li><li><a href="ceph-rbd.html" class=" "><span class="title-number">20 </span><span class="title-name">RADOS Block Device</span></a></li></ol></li><li class="active"><a href="part-accessing-data.html" class="has-children you-are-here"><span class="title-number">IV </span><span class="title-name">Accessing Cluster Data</span></a><ol><li><a href="cha-ceph-gw.html" class=" "><span class="title-number">21 </span><span class="title-name">Ceph Object Gateway</span></a></li><li><a href="cha-ceph-iscsi.html" class=" "><span class="title-number">22 </span><span class="title-name">Ceph iSCSI gateway</span></a></li><li><a href="cha-ceph-cephfs.html" class=" "><span class="title-number">23 </span><span class="title-name">Clustered file system</span></a></li><li><a href="cha-ses-cifs.html" class=" you-are-here"><span class="title-number">24 </span><span class="title-name">Export Ceph data via Samba</span></a></li><li><a href="cha-ceph-nfsganesha.html" class=" "><span class="title-number">25 </span><span class="title-name">NFS Ganesha</span></a></li></ol></li><li><a href="part-integration-virt.html" class="has-children "><span class="title-number">V </span><span class="title-name">Integration with Virtualization Tools</span></a><ol><li><a href="cha-ceph-libvirt.html" class=" "><span class="title-number">26 </span><span class="title-name"><code class="systemitem">libvirt</code> and Ceph</span></a></li><li><a href="cha-ceph-kvm.html" class=" "><span class="title-number">27 </span><span class="title-name">Ceph as a back-end for QEMU KVM instance</span></a></li></ol></li><li><a href="part-cluster-configuration.html" class="has-children "><span class="title-number">VI </span><span class="title-name">Configuring a Cluster</span></a><ol><li><a href="cha-ceph-configuration.html" class=" "><span class="title-number">28 </span><span class="title-name">Ceph cluster configuration</span></a></li><li><a href="cha-mgr-modules.html" class=" "><span class="title-number">29 </span><span class="title-name">Ceph Manager modules</span></a></li><li><a href="cha-storage-cephx.html" class=" "><span class="title-number">30 </span><span class="title-name">Authentication with <code class="systemitem">cephx</code></span></a></li></ol></li><li><a href="bk02apa.html" class=" "><span class="title-number">A </span><span class="title-name">Ceph maintenance updates based on upstream 'Pacific' point releases</span></a></li><li><a href="bk02go01.html" class=" "><span class="title-number"> </span><span class="title-name">Glossary</span></a></li> </ol> </nav><button id="_open-side-toc-overall" title="Contents"> </button><article class="documentation"><button id="_unfold-side-toc-page">On this page</button><section class="chapter" id="cha-ses-cifs" data-id-title="Export Ceph data via Samba"><div class="titlepage"><div><div class="version-info">Applies to  <span class="productname">SUSE Enterprise Storage</span> <span class="productnumber">7.1</span></div><div><h1 class="title"><span class="title-number">24 </span><span class="title-name">Export Ceph data via Samba</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#">#</a></h1></div></div></div><p>
  This chapter describes how to export data stored in a Ceph cluster via a
  Samba/CIFS share so that you can easily access them from Windows* client
  machines. It also includes information that will help you configure a Ceph
  Samba gateway to join Active Directory in the Windows* domain to authenticate and
  authorize users.
 </p><div id="id-1.4.6.5.4" data-id-title="Samba gateway performance" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><h6>Note: Samba gateway performance</h6><p>
   Because of increased protocol overhead and additional latency caused by
   extra network hops between the client and the storage, accessing CephFS
   via a Samba Gateway may significantly reduce application performance when
   compared to native Ceph clients.
  </p></div><section class="sect1" id="cephfs-samba" data-id-title="Export CephFS via Samba share"><div class="titlepage"><div><div><h2 class="title"><span class="title-number">24.1 </span><span class="title-name">Export CephFS via Samba share</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#cephfs-samba">#</a></h2></div></div></div><div id="id-1.4.6.5.5.2" data-id-title="Cross protocol access" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.svg"/><h6>Warning: Cross protocol access</h6><p>
    Native CephFS and NFS clients are not restricted by file locks obtained
    via Samba, and vice versa. Applications that rely on cross protocol file
    locking may experience data corruption if CephFS backed Samba share paths
    are accessed via other means.
   </p></div><section class="sect2" id="cephfs-samba-packages" data-id-title="Configuring and exporting Samba packages"><div class="titlepage"><div><div><h3 class="title"><span class="title-number">24.1.1 </span><span class="title-name">Configuring and exporting Samba packages</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#cephfs-samba-packages">#</a></h3></div></div></div><p>
    To configure and export a Samba share, the following packages need to be
    installed: <span class="package">samba-ceph</span> and
    <span class="package">samba-winbind</span>. If these packages are not installed,
    install them:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">cephuser@smb &gt; </code>zypper install samba-ceph samba-winbind</pre></div></section><section class="sect2" id="sec-ses-cifs-example" data-id-title="Single gateway example"><div class="titlepage"><div><div><h3 class="title"><span class="title-number">24.1.2 </span><span class="title-name">Single gateway example</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#sec-ses-cifs-example">#</a></h3></div></div></div><p>
    In preparation for exporting a Samba share, choose an appropriate node to
    act as a Samba Gateway. The node needs to have access to the Ceph client network,
    as well as sufficient CPU, memory, and networking resources.
   </p><p>
    Failover functionality can be provided with CTDB and the SUSE Linux Enterprise High Availability Extension.
    Refer to <a class="xref" href="cha-ses-cifs.html#sec-ses-cifs-ha" title="24.1.3. Configuring high availability">Section 24.1.3, “Configuring high availability”</a> for more information on HA
    setup.
   </p><div class="procedure"><div class="procedure-contents"><ol class="procedure" type="1"><li class="step"><p>
      Make sure that a working CephFS already exists in your cluster.
     </p></li><li class="step"><p>
      Create a Samba Gateway specific keyring on the Ceph admin node and copy it to
      both Samba Gateway nodes:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">cephuser@adm &gt; </code><code class="command">ceph</code> auth get-or-create client.samba.gw mon 'allow r' \
 osd 'allow *' mds 'allow *' -o ceph.client.samba.gw.keyring
<code class="prompt user">cephuser@adm &gt; </code><code class="command">scp</code> ceph.client.samba.gw.keyring <em class="replaceable">SAMBA_NODE</em>:/etc/ceph/</pre></div><p>
      Replace <em class="replaceable">SAMBA_NODE</em> with the name of the Samba
      gateway node.
     </p></li><li class="step"><p>
      The following steps are executed on the Samba Gateway node. Install Samba
      together with the Ceph integration package:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">cephuser@smb &gt; </code>sudo zypper in samba samba-ceph</pre></div></li><li class="step"><p>
      Replace the default contents of the
      <code class="filename">/etc/samba/smb.conf</code> file with the following:
     </p><div class="verbatim-wrap"><pre class="screen">[global]
  netbios name = SAMBA-GW
  clustering = no
  idmap config * : backend = tdb2
  passdb backend = tdbsam
  # disable print server
  load printers = no
  smbd: backgroundqueue = no

[<em class="replaceable">SHARE_NAME</em>]
  path = <em class="replaceable">CEPHFS_MOUNT</em>
  read only = no
  oplocks = no
  kernel share modes = no</pre></div><p>
      The <em class="replaceable">CEPHFS_MOUNT</em> path above must be mounted
      prior to starting Samba with a kernel CephFS share configuration. See
      <a class="xref" href="cha-ceph-cephfs.html#ceph-cephfs-cephfs-fstab" title="23.3. Mounting CephFS in /etc/fstab">Section 23.3, “Mounting CephFS in <code class="filename">/etc/fstab</code>”</a>.
     </p><p>
      The above share configuration uses the Linux kernel CephFS client,
      which is recommended for performance reasons. As an alternative, the
      Samba <code class="systemitem">vfs_ceph</code> module can also be used to
      communicate with the Ceph cluster. The instructions are shown below for
      legacy purposes and are not recommended for new Samba deployments:
     </p><div class="verbatim-wrap"><pre class="screen">[<em class="replaceable">SHARE_NAME</em>]
  path = /
  vfs objects = ceph
  ceph: config_file = /etc/ceph/ceph.conf
  ceph: user_id = samba.gw
  read only = no
  oplocks = no
  kernel share modes = no</pre></div><div id="id-1.4.6.5.5.4.4.4.6" data-id-title="Oplocks and share modes" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.svg"/><h6>Tip: Oplocks and share modes</h6><p>
       <code class="option">oplocks</code> (also known as SMB2+ leases) allow for improved
       performance through aggressive client caching, but are currently unsafe
       when Samba is deployed together with other CephFS clients, such as
       kernel <code class="literal">mount.ceph</code>, FUSE, or NFS Ganesha.
      </p><p>
       If all CephFS file system path access is exclusively handled by
       Samba, then the <code class="option">oplocks</code> parameter can be safely
       enabled.
      </p><p>
       Currently <code class="option">kernel share modes</code> needs to be disabled in a
       share running with the CephFS vfs module for file serving to work
       properly.
      </p></div><div id="id-1.4.6.5.5.4.4.4.7" data-id-title="Permitting access" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><h6>Important: Permitting access</h6><p>
       Samba maps SMB users and groups to local accounts. Local users can be
       assigned a password for Samba share access via:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code>smbpasswd -a <em class="replaceable">USERNAME</em></pre></div><p>
       For successful I/O, the share path's access control list (ACL) needs to
       permit access to the user connected via Samba. You can modify the ACL
       by temporarily mounting via the CephFS kernel client and using the
       <code class="command">chmod</code>, <code class="command">chown</code>, or
       <code class="command">setfacl</code> utilities against the share path. For
       example, to permit access for all users, run:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code>chmod 777 <em class="replaceable">MOUNTED_SHARE_PATH</em></pre></div></div></li></ol></div></div><section class="sect3" id="samba-service-restart" data-id-title="Starting Samba services"><div class="titlepage"><div><div><h4 class="title"><span class="title-number">24.1.2.1 </span><span class="title-name">Starting Samba services</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#samba-service-restart">#</a></h4></div></div></div><p>
     Start or restart stand-alone Samba services using the following
     commands:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code>systemctl restart smb.service
<code class="prompt root"># </code>systemctl restart nmb.service
<code class="prompt root"># </code>systemctl restart winbind.service</pre></div><p>
     To ensure that Samba services start on boot, enable them via:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code>systemctl enable smb.service
<code class="prompt root"># </code>systemctl enable nmb.service
<code class="prompt root"># </code>systemctl enable winbind.service</pre></div><div id="id-1.4.6.5.5.4.5.6" data-id-title="Optional nmb and winbind services" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.svg"/><h6>Tip: Optional <code class="systemitem">nmb</code> and <code class="systemitem">winbind</code> services</h6><p>
      If you do not require network share browsing, you do not need to enable
      and start the <code class="systemitem">nmb</code> service.
     </p><p>
      The <code class="systemitem">winbind</code> service is only
      needed when configured as an Active Directory domain member. See
      <a class="xref" href="cha-ses-cifs.html#cephfs-ad" title="24.2. Joining Samba Gateway and Active Directory">Section 24.2, “Joining Samba Gateway and Active Directory”</a>.
     </p></div></section></section><section class="sect2" id="sec-ses-cifs-ha" data-id-title="Configuring high availability"><div class="titlepage"><div><div><h3 class="title"><span class="title-number">24.1.3 </span><span class="title-name">Configuring high availability</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#sec-ses-cifs-ha">#</a></h3></div></div></div><div id="id-1.4.6.5.5.5.2" data-id-title="Transparent failover not supported" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><h6>Important: Transparent failover not supported</h6><p>
     Although a multi-node Samba + CTDB deployment is more highly available
     compared to the single node (see <a class="xref" href="cha-ses-cifs.html" title="Chapter 24. Export Ceph data via Samba">Chapter 24, <em>Export Ceph data via Samba</em></a>),
     client-side transparent failover is not supported. Applications will
     likely experience a short outage on Samba Gateway node failure.
    </p></div><p>
    This section provides an example of how to set up a two-node high
    availability configuration of Samba servers. The setup requires the SUSE Linux Enterprise
    High Availability Extension. The two nodes are called <code class="systemitem">earth</code>
    (<code class="systemitem">192.168.1.1</code>) and <code class="systemitem">mars</code>
    (<code class="systemitem">192.168.1.2</code>).
   </p><p>
    For details about SUSE Linux Enterprise High Availability Extension, see
    <a class="link" href="https://documentation.suse.com/sle-ha/15-SP1/" target="_blank">https://documentation.suse.com/sle-ha/15-SP1/</a>.
   </p><p>
    Additionally, two floating virtual IP addresses allow clients to connect to
    the service no matter which physical node it is running on.
    <code class="systemitem">192.168.1.10</code> is used for cluster
    administration with Hawk2 and
    <code class="systemitem">192.168.2.1</code> is used exclusively
    for the CIFS exports. This makes it easier to apply security restrictions
    later.
   </p><p>
    The following procedure describes the example installation. More details
    can be found at
    <a class="link" href="https://documentation.suse.com/sle-ha/15-SP3/html/SLE-HA-all/art-sleha-install-quick.html" target="_blank">https://documentation.suse.com/sle-ha/15-SP3/html/SLE-HA-all/art-sleha-install-quick.html</a>.
   </p><div class="procedure" id="proc-sec-ses-cifs-ha"><div class="procedure-contents"><ol class="procedure" type="1"><li class="step"><p>
      Create a Samba Gateway specific keyring on the Admin Node and copy it to both nodes:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">cephuser@adm &gt; </code><code class="command">ceph</code> auth get-or-create client.samba.gw mon 'allow r' \
    osd 'allow *' mds 'allow *' -o ceph.client.samba.gw.keyring
<code class="prompt user">cephuser@adm &gt; </code><code class="command">scp</code> ceph.client.samba.gw.keyring <code class="systemitem">earth</code>:/etc/ceph/
<code class="prompt user">cephuser@adm &gt; </code><code class="command">scp</code> ceph.client.samba.gw.keyring <code class="systemitem">mars</code>:/etc/ceph/</pre></div></li><li class="step"><p>
      SLE-HA setup requires a fencing device to avoid a <span class="emphasis"><em>split
      brain</em></span> situation when active cluster nodes become
      unsynchronized. For this purpose, you can use a Ceph RBD image with
      Stonith Block Device (SBD). Refer to
      <a class="link" href="https://documentation.suse.com/sle-ha/15-SP3/html/SLE-HA-all/cha-ha-storage-protect.html#sec-ha-storage-protect-fencing-setup" target="_blank">https://documentation.suse.com/sle-ha/15-SP3/html/SLE-HA-all/cha-ha-storage-protect.html#sec-ha-storage-protect-fencing-setup</a>
      for more details.
     </p><p>
      If it does not yet exist, create an RBD pool called
      <code class="literal">rbd</code> (see
      <a class="xref" href="ceph-pools.html#ceph-pools-operate-add-pool" title="18.1. Creating a pool">Section 18.1, “Creating a pool”</a>) and associate it
      with <code class="literal">rbd</code> (see
      <a class="xref" href="ceph-pools.html#ceph-pools-associate" title="18.5.1. Associating pools with an application">Section 18.5.1, “Associating pools with an application”</a>). Then create a related
      RBD image called <code class="literal">sbd01</code>:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">cephuser@adm &gt; </code>ceph osd pool create rbd
<code class="prompt user">cephuser@adm &gt; </code>ceph osd pool application enable rbd rbd
<code class="prompt user">cephuser@adm &gt; </code>rbd -p rbd create sbd01 --size 64M --image-shared</pre></div></li><li class="step"><p>
      Prepare <code class="systemitem">earth</code> and <code class="systemitem">mars</code> to host the Samba service:
     </p><ol type="a" class="substeps"><li class="step"><p>
        Make sure the following packages are installed before you proceed:
        <span class="package">ctdb</span>, <span class="package">tdb-tools</span>, and
        <span class="package">samba</span>.
       </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">zypper</code> in ctdb tdb-tools samba samba-ceph</pre></div></li><li class="step"><p>
        Make sure the Samba and CTDB services are stopped and disabled:
       </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code>systemctl disable ctdb
<code class="prompt root"># </code>systemctl disable smb
<code class="prompt root"># </code>systemctl disable nmb
<code class="prompt root"># </code>systemctl disable winbind
<code class="prompt root"># </code>systemctl stop ctdb
<code class="prompt root"># </code>systemctl stop smb
<code class="prompt root"># </code>systemctl stop nmb
<code class="prompt root"># </code>systemctl stop winbind</pre></div></li><li class="step"><p>
        Open port <code class="literal">4379</code> of your firewall on all nodes. This
        is needed for CTDB to communicate with other cluster nodes.
       </p></li></ol></li><li class="step"><p>
      On <code class="systemitem">earth</code>, create the configuration files for Samba. They will later
      automatically synchronize to <code class="systemitem">mars</code>.
     </p><ol type="a" class="substeps"><li class="step"><p>
        Insert a list of private IP addresses of Samba Gateway nodes in the
        <code class="filename">/etc/ctdb/nodes</code> file. Find more details in the
        ctdb manual page (<code class="command">man 7 ctdb</code>).
       </p><div class="verbatim-wrap"><pre class="screen">192.168.1.1
192.168.1.2</pre></div></li><li class="step"><p>
        Configure Samba. Add the following lines in the
        <code class="literal">[global]</code> section of
        <code class="filename">/etc/samba/smb.conf</code>. Use the host name of your
        choice in place of <em class="replaceable">CTDB-SERVER</em> (all nodes in
        the cluster will appear as one big node with this name). Add a share
        definition as well, consider <em class="replaceable">SHARE_NAME</em> as
        an example:
       </p><div class="verbatim-wrap"><pre class="screen">[global]
  netbios name = SAMBA-HA-GW
  clustering = yes
  idmap config * : backend = tdb2
  passdb backend = tdbsam
  ctdbd socket = /var/lib/ctdb/ctdb.socket
  # disable print server
  load printers = no
  smbd: backgroundqueue = no

[SHARE_NAME]
  path = /
  vfs objects = ceph
  ceph: config_file = /etc/ceph/ceph.conf
  ceph: user_id = samba.gw
  read only = no
  oplocks = no
  kernel share modes = no</pre></div><p>
        Note that the <code class="filename">/etc/ctdb/nodes</code> and
        <code class="filename">/etc/samba/smb.conf</code> files need to match on all
        Samba Gateway nodes.
       </p></li></ol></li><li class="step"><p>
      Install and bootstrap the SUSE Linux Enterprise High Availability cluster.
     </p><ol type="a" class="substeps"><li class="step"><p>
        Register the SUSE Linux Enterprise High Availability Extension on <code class="systemitem">earth</code> and <code class="systemitem">mars</code>:
       </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">root@earth # </code><code class="command">SUSEConnect</code> -r <em class="replaceable">ACTIVATION_CODE</em> -e <em class="replaceable">E_MAIL</em></pre></div><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">root@mars # </code><code class="command">SUSEConnect</code> -r <em class="replaceable">ACTIVATION_CODE</em> -e <em class="replaceable">E_MAIL</em></pre></div></li><li class="step"><p>
        Install <span class="package">ha-cluster-bootstrap</span> on both nodes:
       </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">root@earth # </code><code class="command">zypper</code> in ha-cluster-bootstrap</pre></div><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">root@mars # </code><code class="command">zypper</code> in ha-cluster-bootstrap</pre></div></li><li class="step"><p>
        Map the RBD image <code class="literal">sbd01</code> on both Samba Gateways via
        <code class="systemitem">rbdmap.service</code>.
       </p><p>
        Edit <code class="filename">/etc/ceph/rbdmap</code> and add an entry for the SBD
        image:
       </p><div class="verbatim-wrap"><pre class="screen">rbd/sbd01 id=samba.gw,keyring=/etc/ceph/ceph.client.samba.gw.keyring</pre></div><p>
        Enable and start
        <code class="systemitem">rbdmap.service</code>:
       </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">root@earth # </code>systemctl enable rbdmap.service &amp;&amp; systemctl start rbdmap.service
<code class="prompt user">root@mars # </code>systemctl enable rbdmap.service &amp;&amp; systemctl start rbdmap.service</pre></div><p>
        The <code class="filename">/dev/rbd/rbd/sbd01</code> device should be available
        on both Samba Gateways.
       </p></li><li class="step"><p>
        Initialize the cluster on <code class="systemitem">earth</code> and let <code class="systemitem">mars</code> join it.
       </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">root@earth # </code><code class="command">ha-cluster-init</code></pre></div><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">root@mars # </code><code class="command">ha-cluster-join</code> -c earth</pre></div><div id="id-1.4.6.5.5.5.7.5.2.4.4" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><h6>Important</h6><p>
         During the process of initialization and joining the cluster, you will
         be interactively asked whether to use SBD. Confirm with
         <code class="option">y</code> and then specify
         <code class="filename">/dev/rbd/rbd/sbd01</code> as a path to the storage
         device.
        </p></div></li></ol></li><li class="step"><p>
      Check the status of the cluster. You should see two nodes added in the
      cluster:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">root@earth # </code><code class="command">crm</code> status
2 nodes configured
1 resource configured

Online: [ earth mars ]

Full list of resources:

 admin-ip       (ocf::heartbeat:IPaddr2):       Started earth</pre></div></li><li class="step"><p>
      Execute the following commands on <code class="systemitem">earth</code> to configure the CTDB
      resource:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">root@earth # </code><code class="command">crm</code> configure
<code class="prompt user">crm(live)configure# </code><code class="command">primitive</code> ctdb ocf:heartbeat:CTDB params \
    ctdb_manages_winbind="false" \
    ctdb_manages_samba="false" \
    ctdb_recovery_lock="!/usr/lib64/ctdb/ctdb_mutex_ceph_rados_helper
        ceph client.samba.gw cephfs_metadata ctdb-mutex"
    ctdb_socket="/var/lib/ctdb/ctdb.socket" \
        op monitor interval="10" timeout="20" \
        op start interval="0" timeout="200" \
        op stop interval="0" timeout="100"
<code class="prompt user">crm(live)configure# </code><code class="command">primitive</code> smb systemd:smb \
    op start timeout="100" interval="0" \
    op stop timeout="100" interval="0" \
    op monitor interval="60" timeout="100"
<code class="prompt user">crm(live)configure# </code><code class="command">primitive</code> nmb systemd:nmb \
    op start timeout="100" interval="0" \
    op stop timeout="100" interval="0" \
    op monitor interval="60" timeout="100"
<code class="prompt user">crm(live)configure# </code><code class="command">primitive</code> winbind systemd:winbind \
    op start timeout="100" interval="0" \
    op stop timeout="100" interval="0" \
    op monitor interval="60" timeout="100"
<code class="prompt user">crm(live)configure# </code><code class="command">group</code> g-ctdb ctdb winbind nmb smb
<code class="prompt user">crm(live)configure# </code><code class="command">clone</code> cl-ctdb g-ctdb meta interleave="true"
<code class="prompt user">crm(live)configure# </code><code class="command">commit</code></pre></div><div id="id-1.4.6.5.5.5.7.7.3" data-id-title="Optional nmb and winbind primitives" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.svg"/><h6>Tip: Optional <code class="systemitem">nmb</code> and <code class="systemitem">winbind</code> primitives</h6><p>
       If you do not require network share browsing, you do not need to add the
       <code class="systemitem">nmb</code> primitive.
      </p><p>
       The <code class="systemitem">winbind</code> primitive is only
       needed when configured as an Active Directory domain member. See
       <a class="xref" href="cha-ses-cifs.html#cephfs-ad" title="24.2. Joining Samba Gateway and Active Directory">Section 24.2, “Joining Samba Gateway and Active Directory”</a>.
      </p></div><p>
      The binary
      <code class="command">/usr/lib64/ctdb/ctdb_mutex_ceph_rados_helper</code> in the
      configuration option <code class="literal">ctdb_recovery_lock</code> has the
      parameters <em class="replaceable">CLUSTER_NAME</em>,
      <em class="replaceable">CEPHX_USER</em>,
      <em class="replaceable">RADOS_POOL</em>, and
      <em class="replaceable">RADOS_OBJECT</em>, in this order.
     </p><p>
      An extra lock-timeout parameter can be appended to override the default
      value used (10 seconds). A higher value will increase the CTDB recovery
      master failover time, whereas a lower value may result in the recovery
      master being incorrectly detected as down, triggering flapping failovers.
     </p></li><li class="step"><p>
      Add a clustered IP address:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">crm(live)configure# </code><code class="command">primitive</code> ip ocf:heartbeat:IPaddr2
    params ip=192.168.2.1 \
    unique_clone_address="true" \
    op monitor interval="60" \
    meta resource-stickiness="0"
<code class="prompt user">crm(live)configure# </code><code class="command">clone</code> cl-ip ip \
    meta interleave="true" clone-node-max="2" globally-unique="true"
<code class="prompt user">crm(live)configure# </code><code class="command">colocation</code> col-with-ctdb 0: cl-ip cl-ctdb
<code class="prompt user">crm(live)configure# </code><code class="command">order</code> o-with-ctdb 0: cl-ip cl-ctdb
<code class="prompt user">crm(live)configure# </code><code class="command">commit</code></pre></div><p>
      If <code class="literal">unique_clone_address</code> is set to
      <code class="literal">true</code>, the IPaddr2 resource agent adds a clone ID to
      the specified address, leading to three different IP addresses. These are
      usually not needed, but help with load balancing. For further information
      about this topic, see
      <a class="link" href="https://documentation.suse.com/sle-ha/15-SP3/html/SLE-HA-all/cha-ha-lb.html" target="_blank">https://documentation.suse.com/sle-ha/15-SP3/html/SLE-HA-all/cha-ha-lb.html</a>.
     </p></li><li class="step"><p>
      Check the result:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">root@earth # </code><code class="command">crm</code> status
Clone Set: base-clone [dlm]
     Started: [ factory-1 ]
     Stopped: [ factory-0 ]
 Clone Set: cl-ctdb [g-ctdb]
     Started: [ factory-1 ]
     Started: [ factory-0 ]
 Clone Set: cl-ip [ip] (unique)
     ip:0       (ocf:heartbeat:IPaddr2):       Started factory-0
     ip:1       (ocf:heartbeat:IPaddr2):       Started factory-1</pre></div></li><li class="step"><p>
      Test from a client machine. On a Linux client, run the following command
      to see if you can copy files from and to the system:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">smbclient</code> <code class="option">//192.168.2.1/myshare</code></pre></div></li></ol></div></div><section class="sect3" id="samba-ha-service-restart" data-id-title="Restarting HA Samba resources"><div class="titlepage"><div><div><h4 class="title"><span class="title-number">24.1.3.1 </span><span class="title-name">Restarting HA Samba resources</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#samba-ha-service-restart">#</a></h4></div></div></div><p>
     Following any Samba or CTDB configuration changes, HA resources may need
     to be restarted for the changes to take effect. This can be done by via:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">crm</code> resource restart cl-ctdb</pre></div></section></section></section><section class="sect1" id="cephfs-ad" data-id-title="Joining Samba Gateway and Active Directory"><div class="titlepage"><div><div><h2 class="title"><span class="title-number">24.2 </span><span class="title-name">Joining Samba Gateway and Active Directory</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#cephfs-ad">#</a></h2></div></div></div><p>
   You can configure the Ceph Samba gateway to become a member of Samba
   domain with Active Directory (AD) support. As a Samba domain member, you can use
   domain users and groups in local access lists (ACLs) on files and
   directories from the exported CephFS.
  </p><section class="sect2" id="cephfs-ad-preparation" data-id-title="Preparing Samba installation"><div class="titlepage"><div><div><h3 class="title"><span class="title-number">24.2.1 </span><span class="title-name">Preparing Samba installation</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#cephfs-ad-preparation">#</a></h3></div></div></div><p>
    This section introduces preparatory steps that you need to take care of
    before configuring the Samba itself. Starting with a clean environment
    helps you prevent confusion and verifies that no files from the previous
    Samba installation are mixed with the new domain member installation.
   </p><div id="id-1.4.6.5.6.3.3" data-id-title="Synchronizing clocks" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.svg"/><h6>Tip: Synchronizing clocks</h6><p>
     All Samba Gateway nodes' clocks need to be synchronized with the Active Directory Domain
     controller. Clock skew may result in authentication failures.
    </p></div><p>
    Verify that no Samba or name caching processes are running:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">cephuser@smb &gt; </code>ps ax | egrep "samba|smbd|nmbd|winbindd|nscd"</pre></div><p>
    If the output lists any <code class="literal">samba</code>, <code class="literal">smbd</code>,
    <code class="literal">nmbd</code>, <code class="literal">winbindd</code>, or
    <code class="literal">nscd</code> processes, stop them.
   </p><p>
    If you have previously run a Samba installation on this host, remove the
    <code class="filename">/etc/samba/smb.conf</code> file. Also remove all Samba
    database files, such as <code class="filename">*.tdb</code> and
    <code class="filename">*.ldb</code> files. To list directories containing Samba
    databases, run:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">cephuser@smb &gt; </code>smbd -b | egrep "LOCKDIR|STATEDIR|CACHEDIR|PRIVATE_DIR"</pre></div></section><section class="sect2" id="cephfs-ad-dns" data-id-title="Verifying DNS"><div class="titlepage"><div><div><h3 class="title"><span class="title-number">24.2.2 </span><span class="title-name">Verifying DNS</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#cephfs-ad-dns">#</a></h3></div></div></div><p>
    Active Directory (AD) uses DNS to locate other domain controllers (DCs) and services,
    such as Kerberos. Therefore AD domain members and servers need to be able
    to resolve the AD DNS zones.
   </p><p>
    Verify that DNS is correctly configured and that both forward and reverse
    lookup resolve correctly, for example:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">cephuser@adm &gt; </code>nslookup DC1.domain.example.com
Server:         10.99.0.1
Address:        10.99.0.1#53

Name:   DC1.domain.example.com
Address: 10.99.0.1</pre></div><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">cephuser@adm &gt; </code>10.99.0.1
Server:        10.99.0.1
Address:	10.99.0.1#53

1.0.99.10.in-addr.arpa	name = DC1.domain.example.com.</pre></div></section><section class="sect2" id="cephfs-ad-srv" data-id-title="Resolving SRV records"><div class="titlepage"><div><div><h3 class="title"><span class="title-number">24.2.3 </span><span class="title-name">Resolving SRV records</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#cephfs-ad-srv">#</a></h3></div></div></div><p>
    AD uses SRV records to locate services, such as Kerberos and LDAP. To
    verify that SRV records are resolved correctly, use the
    <code class="command">nslookup</code> interactive shell, for example:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">cephuser@adm &gt; </code>nslookup
Default Server:  10.99.0.1
Address:  10.99.0.1

&gt; set type=SRV
&gt; _ldap._tcp.domain.example.com.
Server:  UnKnown
Address:  10.99.0.1

_ldap._tcp.domain.example.com   SRV service location:
          priority       = 0
          weight         = 100
          port           = 389
          svr hostname   = dc1.domain.example.com
domain.example.com      nameserver = dc1.domain.example.com
dc1.domain.example.com  internet address = 10.99.0.1</pre></div></section><section class="sect2" id="cephfs-ad-kerberos" data-id-title="Configuring Kerberos"><div class="titlepage"><div><div><h3 class="title"><span class="title-number">24.2.4 </span><span class="title-name">Configuring Kerberos</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#cephfs-ad-kerberos">#</a></h3></div></div></div><p>
    Samba supports Heimdal and MIT Kerberos back-ends. To configure Kerberos
    on the domain member, set the following in your
    <code class="filename">/etc/krb5.conf</code> file:
   </p><div class="verbatim-wrap"><pre class="screen">[libdefaults]
	default_realm = DOMAIN.EXAMPLE.COM
	dns_lookup_realm = false
	dns_lookup_kdc = true</pre></div><p>
    The previous example configures Kerberos for the DOMAIN.EXAMPLE.COM realm.
    We do not recommend to set any further parameters in the
    <code class="filename">/etc/krb5.conf</code> file. If your
    <code class="filename">/etc/krb5.conf</code> contains an <code class="literal">include</code>
    line it will not work—you <span class="bold"><strong>must</strong></span>
    remove this line.
   </p></section><section class="sect2" id="cephfs-ad-local-resolution" data-id-title="Resolving localhost name"><div class="titlepage"><div><div><h3 class="title"><span class="title-number">24.2.5 </span><span class="title-name">Resolving localhost name</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#cephfs-ad-local-resolution">#</a></h3></div></div></div><p>
    When you join a host to the domain, Samba tries to register the host name
    in the AD DNS zone. For this, the <code class="command">net</code> utility needs to
    be able to resolve the host name using DNS or using a correct entry in the
    <code class="filename">/etc/hosts</code> file.
   </p><p>
    To verify that your host name resolves correctly, use the <code class="command">getent
    hosts</code> command:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">cephuser@adm &gt; </code>getent hosts example-host
10.99.0.5      example-host.domain.example.com    example-host</pre></div><p>
    The host name and FQDN must not resolve to the 127.0.0.1 IP address or any
    IP address other than the one used on the LAN interface of the domain
    member. If no output is displayed or the host is resolved to the wrong IP
    address and you are not using DHCP, set the correct entry in the
    <code class="filename">/etc/hosts</code> file:
   </p><div class="verbatim-wrap"><pre class="screen">127.0.0.1      localhost
10.99.0.5      example-host.samdom.example.com    example-host</pre></div><div id="id-1.4.6.5.6.7.7" data-id-title="DHCP and /etc/hosts" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.svg"/><h6>Tip: DHCP and <code class="filename">/etc/hosts</code></h6><p>
     If you are using DHCP, check that <code class="filename">/etc/hosts</code> only
     contains the '127.0.0.1' line. If you continue to have problems, contact
     the administrator of your DHCP server.
    </p><p>
     If you need to add aliases to the machine host name, add them to the end
     of the line that starts with the machine's IP address, not to the
     '127.0.0.1' line.
    </p></div></section><section class="sect2" id="cephfs-ad-smb-conf" data-id-title="Configuring Samba"><div class="titlepage"><div><div><h3 class="title"><span class="title-number">24.2.6 </span><span class="title-name">Configuring Samba</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#cephfs-ad-smb-conf">#</a></h3></div></div></div><p>
    This section introduces information about specific configuration options
    that you need to include in the Samba configuration.
   </p><p>
    Active Directory domain membership is primarily configured by setting <code class="literal">security
    = ADS</code> alongside appropriate Kerberos realm and ID mapping
    parameters in the <code class="literal">[global]</code> section of
    <code class="filename">/etc/samba/smb.conf</code>.
   </p><div class="verbatim-wrap"><pre class="screen">[global]
  security = ADS
  workgroup = DOMAIN
  realm = DOMAIN.EXAMPLE.COM
  ...</pre></div><section class="sect3" id="smb-backend-id-mapping-winbindd" data-id-title="Choosing the back-end for ID mapping in winbindd"><div class="titlepage"><div><div><h4 class="title"><span class="title-number">24.2.6.1 </span><span class="title-name">Choosing the back-end for ID mapping in <code class="systemitem">winbindd</code></span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#smb-backend-id-mapping-winbindd">#</a></h4></div></div></div><p>
     If you need your users to have different login shells and/or Unix home
     directory paths, or you want them to have the same ID everywhere, you will
     need to use the winbind 'ad' back-end and add RFC2307 attributes to AD.
    </p><div id="id-1.4.6.5.6.8.5.3" data-id-title="RFC2307 Attributes and ID Numbers" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><h6>Important: RFC2307 Attributes and ID Numbers</h6><p>
      The RFC2307 attributes are not added automatically when users or groups
      are created.
     </p><p>
      The ID numbers found on a DC (numbers in the 3000000 range) are
      <span class="emphasis"><em>not</em></span> RFC2307 attributes and will not be used on Unix
      Domain Members. If you need to have the same ID numbers everywhere, add
      <code class="literal">uidNumber</code> and <code class="literal">gidNumber</code> attributes
      to AD and use the winbind 'ad' back-end on Unix Domain Members. If you do
      decide to add <code class="literal">uidNumber</code> and
      <code class="literal">gidNumber</code> attributes to AD, do not use numbers in the
      3000000 range.
     </p></div><p>
     If your users will only use the Samba AD DC for authentication and will
     not store data on it or log in to it, you can use the winbind 'rid'
     back-end. This calculates the user and group IDs from the Windows* RID. If
     you use the same <code class="literal">[global]</code> section of the
     <code class="filename">smb.conf</code> on every Unix domain member, you will get
     the same IDs. If you use the 'rid' back-end, you do not need to add
     anything to AD and RFC2307 attributes will be ignored. When using the
     'rid' back-end, set the <code class="option">template shell</code> and
     <code class="option">template homedir</code> parameters in
     <code class="filename">smb.conf</code>. These settings are global and everyone gets
     the same login shell and Unix home directory path (unlike the RFC2307
     attributes where you can set individual Unix home directory paths and
     shells).
    </p><p>
     There is another way of setting up Samba—when you require your
     users and groups to have the same ID everywhere, but only need your users
     to have the same login shell and use the same Unix home directory path.
     You can do this by using the winbind 'ad' back-end and using the template
     lines in <code class="filename">smb.conf</code>. This way you only need to add
     <code class="literal">uidNumber</code> and <code class="literal">gidNumber</code> attributes
     to AD.
    </p><div id="id-1.4.6.5.6.8.5.6" data-id-title="More Information about Back-ends for ID Mapping" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.svg"/><h6>Tip: More Information about Back-ends for ID Mapping</h6><p>
      Find more detailed information about available ID mapping back-ends in
      the related manual pages: <code class="command">man 8 idmap_ad</code>, <code class="command">man
      8 idmap_rid</code>, and <code class="command">man 8 idmap_autorid</code>.
     </p></div></section><section class="sect3" id="smb-setting-user-group-id-ranges" data-id-title="Setting user and group ID ranges"><div class="titlepage"><div><div><h4 class="title"><span class="title-number">24.2.6.2 </span><span class="title-name">Setting user and group ID ranges</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#smb-setting-user-group-id-ranges">#</a></h4></div></div></div><p>
     After you decide which winbind back-end to use, you need to specify the
     ranges to use with the <code class="option">idmap config</code> option in
     <code class="filename">smb.conf</code>. By default, there are multiple blocks of
     user and group IDs reserved on a Unix domain member:
    </p><div class="table" id="id-1.4.6.5.6.8.6.3" data-id-title="Default Users and Group ID Blocks"><div class="table-title-wrap"><h6 class="table-title"><span class="title-number">Table 24.1: </span><span class="title-name">Default Users and Group ID Blocks </span><a title="Permalink" class="permalink" href="cha-ses-cifs.html#id-1.4.6.5.6.8.6.3">#</a></h6></div><div class="table-contents"><table style="width: 50%; border-collapse: collapse; border-top: 1px solid ; border-bottom: 1px solid ; border-left: 1px solid ; border-right: 1px solid ; "><colgroup><col/><col/></colgroup><thead><tr><th style="border-right: 1px solid ; border-bottom: 1px solid ; ">IDs</th><th style="border-bottom: 1px solid ; ">Range</th></tr></thead><tbody><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; ">0-999</td><td style="border-bottom: 1px solid ; ">Local system users and groups.</td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; ">Starting at 1000</td><td style="border-bottom: 1px solid ; ">Local Unix users and groups.</td></tr><tr><td style="border-right: 1px solid ; ">Starting at 10000</td><td>DOMAIN users and groups.</td></tr></tbody></table></div></div><p>
     As you can see from the above ranges, you should not set either the '*' or
     'DOMAIN' ranges to start at 999 or less, as they would interfere with the
     local system users and groups. You also should leave a space for any local
     Unix users and groups, so starting the <code class="option">idmap config</code>
     ranges at 3000 seems to be a good compromise.
    </p><p>
     You need to decide how large your 'DOMAIN' is likely to grow and if you
     plan to have any trusted domains. Then you can set the <code class="option">idmap
     config</code> ranges as follows:
    </p><div class="table" id="id-1.4.6.5.6.8.6.6" data-id-title="ID Ranges"><div class="table-title-wrap"><h6 class="table-title"><span class="title-number">Table 24.2: </span><span class="title-name">ID Ranges </span><a title="Permalink" class="permalink" href="cha-ses-cifs.html#id-1.4.6.5.6.8.6.6">#</a></h6></div><div class="table-contents"><table style="width: 50%; border-collapse: collapse; border-top: 1px solid ; border-bottom: 1px solid ; border-left: 1px solid ; border-right: 1px solid ; "><colgroup><col/><col/></colgroup><thead><tr><th style="border-right: 1px solid ; border-bottom: 1px solid ; ">Domain</th><th style="border-bottom: 1px solid ; ">Range</th></tr></thead><tbody><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; ">*</td><td style="border-bottom: 1px solid ; ">3000-7999</td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; ">DOMAIN</td><td style="border-bottom: 1px solid ; ">10000-999999</td></tr><tr><td style="border-right: 1px solid ; ">TRUSTED</td><td>1000000-9999999</td></tr></tbody></table></div></div></section><section class="sect3" id="smb-mapping-domain-admin-account-local" data-id-title="Mapping the domain administrator account to the local root user"><div class="titlepage"><div><div><h4 class="title"><span class="title-number">24.2.6.3 </span><span class="title-name">Mapping the domain administrator account to the local <code class="systemitem">root</code> user</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#smb-mapping-domain-admin-account-local">#</a></h4></div></div></div><p>
     Samba enables you to map domain accounts to a local account. Use this
     feature to execute file operations on the domain member's file system as a
     different user than the account that requested the operation on the
     client.
    </p><div id="id-1.4.6.5.6.8.7.3" data-id-title="Mapping the Domain Administrator (Optional)" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.svg"/><h6>Tip: Mapping the Domain Administrator (Optional)</h6><p>
      Mapping the domain administrator to the local <code class="systemitem">root</code> account is
      optional. Only configure the mapping if the domain administrator needs to
      be able to execute file operations on the domain member using <code class="systemitem">root</code>
      permissions. Be aware that mapping Administrator to the <code class="systemitem">root</code>
      account does not allow you to log in to Unix domain members as
      'Administrator'.
     </p></div><p>
     To map the domain administrator to the local <code class="systemitem">root</code> account, follow
     these steps:
    </p><div class="procedure"><div class="procedure-contents"><ol class="procedure" type="1"><li class="step"><p>
       Add the following parameter to the <code class="literal">[global]</code> section
       of your <code class="filename">smb.conf</code> file:
      </p><div class="verbatim-wrap"><pre class="screen">username map = /etc/samba/user.map</pre></div></li><li class="step"><p>
       Create the <code class="filename">/etc/samba/user.map</code> file with the
       following content:
      </p><div class="verbatim-wrap"><pre class="screen">!root = <em class="replaceable">DOMAIN</em>\Administrator</pre></div></li></ol></div></div><div id="id-1.4.6.5.6.8.7.6" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><h6>Important</h6><p>
      When using the 'ad' ID mapping back-end, do not set the
      <code class="option">uidNumber</code> attribute for the domain administrator
      account. If the account has the attribute set, the value overrides the
      local UID '0' of the <code class="systemitem">root</code> user, and therefore the mapping fails.
     </p></div><p>
     For more details, see the <code class="option">username map</code> parameter in the
     <code class="filename">smb.conf</code> manual page (<code class="command">man 5
     smb.conf</code>).
    </p></section></section><section class="sect2" id="cephfs-ad-joining" data-id-title="Joining the Active Directory domain"><div class="titlepage"><div><div><h3 class="title"><span class="title-number">24.2.7 </span><span class="title-name">Joining the Active Directory domain</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#cephfs-ad-joining">#</a></h3></div></div></div><p>
    To join the host to an Active Directory, run:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">cephuser@smb &gt; </code>net ads join -U administrator
Enter administrator's password: <em class="replaceable">PASSWORD</em>
Using short domain name -- <em class="replaceable">DOMAIN</em>
Joined <em class="replaceable">EXAMPLE-HOST</em> to dns domain <em class="replaceable">'DOMAIN</em>.example.com'</pre></div></section><section class="sect2" id="cephfs-ad-nss" data-id-title="Configuring the name service switch"><div class="titlepage"><div><div><h3 class="title"><span class="title-number">24.2.8 </span><span class="title-name">Configuring the name service switch</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#cephfs-ad-nss">#</a></h3></div></div></div><p>
    To make domain users and groups available to the local system, you need to
    enable the name service switch (NSS) library. Append the
    <code class="option">winbind</code> entry to the following databases in the
    <code class="filename">/etc/nsswitch.conf</code> file:
   </p><div class="verbatim-wrap"><pre class="screen">passwd: files winbind
group:  files winbind</pre></div><div id="id-1.4.6.5.6.10.4" data-id-title="Points to Consider" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><h6>Important: Points to Consider</h6><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
       Keep the <code class="option">files</code> entry as the first source for both
       databases. This enables NSS to look up domain users and groups from the
       <code class="filename">/etc/passwd</code> and <code class="filename">/etc/group</code>
       files before querying the
       <code class="systemitem">winbind</code> service.
      </p></li><li class="listitem"><p>
       Do not add the <code class="option">winbind</code> entry to the NSS
       <code class="literal">shadow</code> database. This can cause the
       <code class="command">wbinfo</code> utility to fail.
      </p></li><li class="listitem"><p>
       Do not use the same user names in the local
       <code class="filename">/etc/passwd</code> file as in the domain.
      </p></li></ul></div></div></section><section class="sect2" id="cephfs-ad-services" data-id-title="Starting the services"><div class="titlepage"><div><div><h3 class="title"><span class="title-number">24.2.9 </span><span class="title-name">Starting the services</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#cephfs-ad-services">#</a></h3></div></div></div><p>
    Following configuration changes, restart Samba services as per
    <a class="xref" href="cha-ses-cifs.html#samba-service-restart" title="24.1.2.1. Starting Samba services">Section 24.1.2.1, “Starting Samba services”</a> or
    <a class="xref" href="cha-ses-cifs.html#samba-ha-service-restart" title="24.1.3.1. Restarting HA Samba resources">Section 24.1.3.1, “Restarting HA Samba resources”</a>.
   </p></section><section class="sect2" id="cephfs-ad-testing" data-id-title="Test the winbindd connectivity"><div class="titlepage"><div><div><h3 class="title"><span class="title-number">24.2.10 </span><span class="title-name">Test the <code class="systemitem">winbindd</code> connectivity</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#cephfs-ad-testing">#</a></h3></div></div></div><section class="sect3" id="cephfs-ad-send-ping" data-id-title="Sending a winbindd ping"><div class="titlepage"><div><div><h4 class="title"><span class="title-number">24.2.10.1 </span><span class="title-name">Sending a <code class="systemitem">winbindd</code> ping</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#cephfs-ad-send-ping">#</a></h4></div></div></div><p>
     To verify if the <code class="systemitem">winbindd</code> service
     is able to connect to AD Domain Controllers (DC) or a primary domain
     controller (PDC), enter:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">cephuser@smb &gt; </code>wbinfo --ping-dc
checking the NETLOGON for domain[<em class="replaceable">DOMAIN</em>] dc connection to "DC.DOMAIN.EXAMPLE.COM" succeeded</pre></div><p>
     If the previous command fails, verify that the
     <code class="systemitem">winbindd</code> service is running and
     that the <code class="filename">smb.conf</code> file is set up correctly.
    </p></section><section class="sect3" id="smb-domain-users-groups-cephfs" data-id-title="Looking up domain users and groups"><div class="titlepage"><div><div><h4 class="title"><span class="title-number">24.2.10.2 </span><span class="title-name">Looking up domain users and groups</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#smb-domain-users-groups-cephfs">#</a></h4></div></div></div><p>
     The <code class="systemitem">libnss_winbind</code> library enables you to look up
     domain users and groups. For example, to look up the domain user
     'DOMAIN\demo01':
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">cephuser@smb &gt; </code>getent passwd DOMAIN\\demo01
DOMAIN\demo01:*:10000:10000:demo01:/home/demo01:/bin/bash</pre></div><p>
     To look up the domain group 'Domain Users':
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">cephuser@smb &gt; </code>getent group "DOMAIN\\Domain Users"
DOMAIN\domain users:x:10000:</pre></div></section><section class="sect3" id="smb-assign-file-perms-domain-users-groups" data-id-title="Assigning file permissions to domain users and groups"><div class="titlepage"><div><div><h4 class="title"><span class="title-number">24.2.10.3 </span><span class="title-name">Assigning file permissions to domain users and groups</span> <a title="Permalink" class="permalink" href="cha-ses-cifs.html#smb-assign-file-perms-domain-users-groups">#</a></h4></div></div></div><p>
     The name service switch (NSS) library enables you to use domain user
     accounts and groups in commands. For example to set the owner of a file to
     the 'demo01' domain user and the group to the 'Domain Users' domain group,
     enter:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">cephuser@smb &gt; </code>chown "DOMAIN\\demo01:DOMAIN\\domain users" file.txt</pre></div></section></section></section></section><nav class="bottom-pagination"><div><a class="pagination-link prev" href="cha-ceph-cephfs.html"><span class="pagination-relation">Previous</span><span class="pagination-label"><span class="title-number">Chapter 23 </span>Clustered file system</span></a> </div><div><a class="pagination-link next" href="cha-ceph-nfsganesha.html"><span class="pagination-relation">Next</span><span class="pagination-label"><span class="title-number">Chapter 25 </span>NFS Ganesha</span></a> </div></nav></article><aside id="_side-toc-page" class="side-toc"><div class="side-title">On this page</div><div class="toc"><ul><li><span class="sect1"><a href="cha-ses-cifs.html#cephfs-samba"><span class="title-number">24.1 </span><span class="title-name">Export CephFS via Samba share</span></a></span></li><li><span class="sect1"><a href="cha-ses-cifs.html#cephfs-ad"><span class="title-number">24.2 </span><span class="title-name">Joining Samba Gateway and Active Directory</span></a></span></li></ul></div><div class="side-title">Give feedback</div><ul class="feedback" id="_give-feedback"><li><a id="_feedback-editurl" href="https://github.com/SUSE/doc-ses/edit/main/xml/deployment_cifs.xml" rel="nofollow" target="_blank">Edit source document</a></li></ul><div class="side-title">Share this page</div><ul class="share"><li><a id="_share-fb" href="#" title="Facebook"> </a></li><li><a id="_share-in" href="#" title="LinkedIn"> </a></li><li><a id="_share-tw" href="#" title="Twitter"> </a></li><li><a id="_share-mail" href="#" title="E-Mail"> </a></li><li><a id="_print-button" href="#" title="Print this page"> </a></li></ul> </aside></main><footer id="_footer"><div class="growth-inhibitor"><div class="copy"><span class="copy__rights">© SUSE
                 2022</span></div></div></footer></body></html>